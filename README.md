# jef4j

## はじめに

jef4j は、富士通株式会社のメインフレームで使われていた JEF 漢字コード体系と Unicode を相互変換するための　Java 用 Charset ライブラリです。

JEF漢字コード体系は、Unicodeの整備も進んだ今となっては消え行く定めにあるものではありますが、メインフレームはいまだ多数が存在しており、既存システムの資産のデータ移行には必要となる技術です。

今回調べて、改めてわかったことですが、JEF 漢字コードは、 1979 年に策定されたからと言って決して古びた過去の体系ではないということです。拡張漢字領域まで含めると、様々な漢字が広範囲に渡って収録されており、最新の Unicode 体系と照らし合わせても異体字領域まで含めないとマッピングできない文字すら存在しています。おそらく、公共機関の要請もあったものでしょう。その意味で日本の基盤を支える文字コード体系として今現在も使い続けられているものです。

残念なことに JEF コード体系は、富士通株式会社外には正式に公開されていません。このライブラリの作成にあたり、インターネット上で取得できるツールや文献だけを元にマッピングを作成しておりますが、そのため特にJEF拡張漢字領域に関しマッピングが不完全な状態です（現時点でのマッピングは[ここ](docs/mappings.html)にあります）。文字コードの対応をご連絡いただければマージしたいと思います。Issue や Pull Request でご連絡をお願いします。

- [JHT(ホスト連携ツール)SIMPLE版](http://www.vector.co.jp/soft/winnt/util/se094205.html)：Windows-31J の範囲は概ねこのツールからマッピングを生成しています。ただ、マッピングの一部に不備が見つかったため、その部分だけ修正を加えています。
- [Linkexpress 運用ガイド コード変換型の対応表(EUC(S90)系/JEF-EBCDIC系)](http://software.fujitsu.com/jp/manual/manualfiles/m140001/j2x15930/12z200/unyo05/unyo0424.html)：JEF 拡張漢字の一部は JIS の字体変更の影響により一部がここに記載されています。このライブラリでは、Unicode との変換を目的としているため字形重視でマッピングしています。
- [Canon F359 ユーザーズガイド](http://cweb.canon.jp/manual/lasershot/pdf/crmes-f359.pdf)：JEF 拡張非漢字のマッピングはこのガイドを元に作成しています。一部 Unicode への適当なマッピング先が見つからないため、変換できないものもあります。

なお、このプロダクトは富士通株式会社とはまったく関係ありませんので問い合わせはご遠慮ください。私自身も富士通社のメインフレームを触ったことがなく、汎用機の知識を前提にした質問を頂いても回答しかねますのであらかじめお断りしておきます。

## JEF漢字コード体系の構造

JEF漢字コード体系自体はJIS非漢字、JIS第一水準、第二水準からなる標準のコード域と拡張漢字、拡張非漢字と呼ばれる追加のコード域から構成される2バイトのコード体系です。JISコード域の字体は、78JIS(JIS C 6226:1978)に基づいており、SHIFT_JIS などとは異なり 83JIS(JIS X 0208:1983)での字形変更は行われていません。その代わり、変更後の字体は拡張漢字領域に追加されています。

|カテゴリ|コード域|
|-----|------|
|全角空白|0x4040|
|拡張漢字/拡張非漢字|0x41A1～0x7FFE|
|利用者定義|0x80A1～0xA0FE|
|標準漢字/標準非漢字|0xA1A2～0xFEFE|

拡張漢字/拡張非漢字の領域は、JISコード外の文字も多く含まれます。ブラウザなどで利用する場合には、追加の拡張漢字サポート製品を購入する必要があります。そのため、多くの場合、標準漢字の範囲内を原則とし一部の文字のみを外字登録して使うなどといった限定的な利用に留めるケースが多く、商用ツールでもほとんどサポートされていないようです。

JEF漢字はJISコードにもとづいているため、半角英数は含まれていません。そのため、メインフレームで一般的に使われる EBCDIC と共に使用されます。EBCDICのコード体系としては、IBM-EBCDIC 相当、日立製作所 EBCDIK 相当、US-ASCII 可換の3種類が存在します。これらは1バイトのコード体系ですが、SHIFT_JISのように2バイトコード体系とコード範囲が重複するため混在しての利用ができません。このため、次に記したシフトコードを使って1バイトコード体系と2バイトコード体系の切り替えを行います。

|カテゴリ|コード値|備考|
|-----|------|----|
|シフトイン(12pt)|0x28||
|シフトイン(9pt)|0x38|エンコード時は 0x28 を使用します。|
|シフトアウト|0x29||

## インストール

Maven Central Repository から取得できます。

```xml
<dependency>
  <groupId>net.arnx</groupId>
  <artifactId>jef4j</artifactId>
  <version>0.1.0</version>
</dependency>
```

## 使い方

jef4j 用に特別なAPIが用意されているわけではありませんので、クラスパスに追加だけ行えば、下記のような Java 標準 API を通して使用できます。

- new String(byte[] chars, String charset)
- String.getBytes(String charset)
- Charset.forName(String charset)

```java
Charset charset = Charset.forName("x-Fujitsu-JEF");
String text = new String(bytes, charset);
byte[] bytes = text.getBytes(charset);
```

指定できる文字セット名は次の通りです。

|文字セット名|説明|
|----------|----|
|x-Fujitsu-EBCDIC|英小文字用 EBCDIC のコード表です。|
|x-Fujitsu-EBCDIK|カナ文字用 EBCDIC のコード表です。|
|x-Fujitsu-ASCII|ASCII互換用 EBCDIC のコード表です。|
|x-Fujitsu-JEF|JEF漢字のみのコード表です。|
|x-Fujitsu-JEF-EBCDIC|1バイト領域の英小文字用 EBCDIC と2バイト領域の JEF 漢字をシフトイン/シフトアウトで切り替えます。|
|x-Fujitsu-JEF-EBCDIK|1バイト領域のカナ文字用 EBCDIC と2バイト領域の JEF 漢字をシフトイン/シフトアウトで切り替えます。|
|x-Fujitsu-JEF-ASCII|1バイト領域のASCII互換用 EBCDIC と2バイト領域の JEF 漢字をシフトイン/シフトアウトで切り替えます。|

変換に失敗した場合の置換文字としては、半角/全角空白が使用されます。Windows-31J など他の文字コードでは'?'が使用されますが、シフトイン/シフトアウトでの切り替えがあるため、どちらでも有効な文字として解釈できる空白文字' 'に置換しています。

## ライセンス

Apache License 2.0 で配布します。
